package models

import (
	"time"

	"gorm.io/datatypes"
	"gorm.io/gorm"
)

const (
	VulnerabilitySchemaTypeOpenSSF = "OpenSSF"
	VulnerabilitySourceOpenSSF     = VulnerabilitySchemaTypeOpenSSF
)

type Vulnerability struct {
	gorm.Model

	// Lookup key, must be unique (Composite index on MySQL 8 must be < 3072/4 with utf8mb4)
	Ecosystem string `gorm:"type:varchar(32);not null;index:lookup_idx;priority:1"`
	Group     string `gorm:"type:varchar(512);not null;index:lookup_idx;priority:2"`
	Name      string `gorm:"type:varchar(128);not null;index:lookup_idx;priority:3"`

	// Meta data to deserialize Data into appropriate vulnerability model
	SchemaType    string `gorm:"type:varchar(32);not null"`
	SchemaVersion string `gorm:"type:varchar(32);not null"`

	// Common vulnerability data
	ExternalSource string `gorm:"type:varchar(32);not null;uniqueIndex:external_src_idx;priority:1"`
	ExternalId     string `gorm:"type:varchar(128);unique;not null;uniqueIndex:external_src_idx;priority:2"`
	Title          string `gorm:"not null"`
	Description    string `gorm:"not null"`

	// JSON serialized vulnerability data in SchemaType/SchemaVersion format
	Data datatypes.JSON `gorm:"not null;size:2097152"`

	// Timestamp for vulnerability data from external sources
	DataModifiedAt  time.Time `gorm:"not null"`
	DataPublishedAt time.Time `gorm:"not null"`
}
